## 1.TCP

### 1.1数据格式

数据偏移：

用来计算首部长度，首部的长度可以理解为右边数据的偏移   

![image-20230922121328958](imgs\image-20230922121328958.png)



![image-20230925152048301](imgs\image-20230925152048301.png)

### 1.2检验和

![image-20230922145040479](imgs\image-20230922145040479.png)

![image-20230922145603162](imgs\image-20230922145603162.png)



### 1.3小细节

有的资料说有九个标志位，但左边三位目前没什么用，可以理解为左边三位加上保留位总共6位保留位

![image-20230922150301071](imgs\image-20230922150301071.png)

![image-20230922150355613](imgs\image-20230922150355613.png)



### 1.4一个细节

![image-20230922120847831](imgs\image-20230922120847831.png)

### 1.5标志位

紧急指针字段里的数值代表数据部分前面有多少字节属于紧急数据,优先发送  

ACK是传输层给传输层之间的回应

![image-20230922151502899](imgs\image-20230922151502899.png)

![image-20230922154534442](imgs\image-20230922154534442.png)



建立HTTP之前，有三次TCP请求（三次握手），三次握手成功后，发送HTTP请求

![image-20230922152324633](imgs\image-20230922152324633.png)

### 1.6序号、确认号、窗口

传输过程中的每一份字节都有一个编号 

与服务器建立连接后，服务器传来100个字节，客户端会发请求，首部里会有确认号(101)，服务器就会发101开始的数据，首部里会有序号(101)

![image-20230922155529854](imgs\image-20230922155529854.png)



## 2.要点

可靠传输：服务器返回的数据过大时，会分段传输，其他一段丢失了，服务器会重新补发，保证数据的完整性

流量控制：发请求给服务器的过程中，顺便告诉服务器客户端的接收窗口大小（传输层有缓存，用来接收服务器发来的数据包，但是有大小限制）

![image-20230921211743233](imgs\image-20230921211743233.png)

![image-20230922165311430](imgs\image-20230922165311430.png)

## 3.可靠传输

### 3.1停止等待ARQ协议

可以保证可靠传输，但效率太低

![image-20230922165501721](imgs\image-20230922165501721.png)

![image-20230922170258302](imgs\image-20230922170258302.png)

### 3.2连续ARQ协议+滑动窗口协议

连续ARQ协议，分组连续发送，对方连续收到后，一口气确认（只告诉最后一个，有顺序）

滑动窗口协议，发送方窗口大小由接收方决定（传输层里有缓存窗口，决定发送方能发多少数据），**发送完一组后，窗口会往下滑**，用作下一组

![image-20230922170609350](imgs\image-20230922170609350.png)

![image-20230925151659054](imgs\image-20230925151659054.png)

每一段都有TCP首部

发送缓存、发送窗口和接收缓存、接收窗口

丢包时，为防止重复发包，会使用SACK（选择性确认）技术

给回确认的过程中，会顺便告诉此时的窗口大小，比如，丢失一个包，此时窗口大小为300

![image-20230922171921139](imgs\image-20230922171921139.png)

### 3.3选择性确认

![image-20230925143710929](imgs\image-20230925143710929.png)

 确认号为201，共有4组边界信息![image-20230925143645960](imgs\image-20230925143645960.png)

![image-20230925150738919](imgs\image-20230925150738919.png)

 

相对序号为1，并未真正存储在首部中，而是wiresharks根据本次和上次的真实序号（来自当初连接时的值）相减，计算出来的

首部中存储的是真实序号：3277832203

确认号与序号同理

![image-20230925150939298](imgs\image-20230925150939298.png)

## 4.总结

三次TCP请求（三次握手），建立HTTP通道，

文件很大时，在传输层就开始分段了（在传输层拆的就很干净了），每一段会加上TCP首部，再加上其他层的首部

发送数据根据窗口大小决定发送大小（连续ARQ协议+滑动窗口协议）

![image-20230925155805750](imgs\image-20230925155805750.png)

## 5.疑问

### 5.1重发问题

![image-20230925161420668](imgs\image-20230925161420668.png)

### 5.2不足接收窗口大小

接收窗口为400，实际发送的数据为200，接收方会等一定时间，如果仍未收到数据，就会再给回确认，收到了200

![image-20230925162611896](imgs\image-20230925162611896.png)

### 5.3为什么传输层分割

![image-20230925162936680](imgs\image-20230925162936680.png)

假设等到网络层再分片，路由器忙不过来，丢掉数据，网络层和数据链路层没有重传功能（负责打包，发送，无可靠传输功能），不会重传。数据丢失后，接收方的传输层拿不到完整的数据，导致不会给发送方ACK，发送方传输层会超时，重新传一个大包过来（对传输层而言，就一个大包）

![image-20230925172436130](imgs\image-20230925172436130.png)

传输层进行分段，如果有一个包丢了，只用传这一个包

![image-20230925172654737](imgs\image-20230925172654737.png)

