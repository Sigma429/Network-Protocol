## 1.建立连接

建立连接是传输层的概念

建立好连接后，客户端正式发送HTTP请求给服务器，服务器用TCP发送数据（发送请求后，页面的数据），保证可靠传输

三次握手只有首部，没有数据部分

三次握手前两次的SYN（同步）为1，表示同步请求，要连接，序号为0

后两次的ACK（确认）为1，表示要确认

![image-20230926171529642](imgs\image-20230926171529642.png)

![image-20230926171622359](imgs\image-20230926171622359.png)

### 1.1 3次握手

在进行三次握手时，TCP 协议确实依赖于网络层（OSI 模型中的第三层）提供的 IP（Internet Protocol）服务来传输数据包

（运输层经网络层、数据链路层、物理层的添加与拆解进行传输，而不是直接传到对应层），但握手过程本身是在传输层完成的![image-20230928214426978](imgs\image-20230928214426978.png)



### 1.2 状态解读

![image-20230929164042150](imgs\image-20230929164042150.png)

### 1.3 前2次握手的特点

建立连接过程前两次握手首部一般为32字节，固定部分为20字节

选项部分：MSS、是否支持SACK、Window scale等等

有效窗口大小 = 窗口大小字段值 * 2^Window scale

前两次握手，双方会交换一些信息

![image-20230929164053739](imgs\image-20230929164053739.png)

前两次握手在选项部分中先给出Window scale（32字节），之后才进行有效窗口大小的计算

![image-20230929170144743](imgs\image-20230929170144743.png)

10.0.0.167 -> 111.206.147.164(第一次握手)

![image-20230929170058146](imgs\image-20230929170058146.png)

111.206.147.164  -> 10.0.0.167(第二次握手)

![image-20230929170239158](imgs\image-20230929170239158.png)

10.0.0.167 -> 111.206.147.164(第三次握手)

![image-20230929170134904](imgs\image-20230929170134904.png)

111.206.147.164  -> 10.0.0.167(传输数据)

![image-20230929170526091](imgs\image-20230929170526091.png)

### 1.4 疑问

如果建立连接只需2次握手，迟到的连接请求，在连接释放后，才到达server

在客户端看来，要的东西已经有了，不会再发一次HTTP请求

但在服务器看来，两次握手就已经建立连接了，服务器单方面认为已建立连接，会一直等待客户端发请求，导致浪费资源

![image-20230929173006236](imgs\image-20230929173006236.png)

 

![image-20230929172351500](imgs\image-20230929172351500.png)



![](imgs\image-20230929174331785.png)

![image-20230929182440704](imgs\image-20230929182440704.png)

![image-20230929180317647](imgs\image-20230929180317647.png)



## 2.序号、确认号 

### 2.1概述

![image-20230926172148274](imgs\image-20230926172148274.png)

三、四步可以理解为对第二步的回应

![image-20230926172630754](imgs\image-20230926172630754.png)

分段传输时，ACK不变，因为客户端未传输数据

第N个包的序号：前面N-1个包的总长度+1

![image-20230927144715617](imgs\image-20230927144715617.png)

确认作用，TCP数据部分为0

![image-20230927145635431](imgs\image-20230927145635431.png)

![image-20230928214312935](imgs\image-20230928214312935.png)

### 2.2相对值

返回的ACK号为发送的序号+数据长度

![image-20230926183708549](imgs\image-20230926183708549.png)

### 2.3原生值

**双方在建立连接时，确定原生值** 

返回的ACK号为发送的真正的序号+数据长度 

![image-20230926200422188](imgs\image-20230926200422188.png)

![image-20230926211235245](C:\Users\10597\AppData\Roaming\Typora\typora-user-images\image-20230926211235245.png)

### 2.4变化过程

第一次握手，客户端发送序号初始值 

![image-20230926200650307](imgs\image-20230926200650307.png)

第二次握手，服务器端发送序号初始值和ACK值，ACK值为收到的客户端序号初始值+1 （收到0个字节，希望对方从第一个字节发）

![image-20230926200701610](imgs\image-20230926200701610.png)

第三次握手，客户端发送序号值（收到的ACK值）和ACK值，ACK值为收到的服务端序号初始值+1

![image-20230926200711120](imgs\image-20230926200711120.png)

发送数据，返回的ACK号为发送的序号+数据长度

![image-20230926171529642](imgs\image-20230926171529642.png)

![image-20230926171622359](C:\Users\10597\AppData\Roaming\Typora\typora-user-images\image-20230926171622359.png)

