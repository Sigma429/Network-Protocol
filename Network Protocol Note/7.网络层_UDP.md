## 1.网络层

### 1.1概述

固定部分为20字节，首部可变部分最多40字节（首部长度在20~60 ） 

网络层的数据部分不一定是由传输层传递下来的，有些协议没有应用层和传输层，只有三层，甚至两层

像ICMP协议直接就是网络层，网络层首部+网络层数据部分（直接是ICMP的首部和具体数据），不会从传输层传下来

![image-20230919112322489](imgs\image-20230919112322489.png)

![image-20230919162114465](imgs\image-20230919162114465.png)

![image-20230919190205347](imgs\image-20230919190205347.png)


IP（Internet Protocol）和 ICMP（Internet Control Message Protocol）是两种不同的网络协议，但它们在互联网通信中有密切的关系。

1. **IP协议：** IP是一种网络层协议，负责在计算机网络中定位和传输数据包。它提供了一种将数据从源主机路由到目标主机的机制，以确保数据能够正确地传输到它们的目的地。IP协议本身不提供任何错误检测或纠正机制，因此它侧重于将数据包传输到目标，但不关心数据包的状态或内容。
2. **ICMP协议：** ICMP是一种网络层的附加协议，用于在IP网络中传递控制和错误消息。它允许网络设备和主机之间交换有关网络状态、错误和问题的信息。最常见的用例是ping命令，它使用ICMP Echo请求和回复消息来测试网络上的主机是否可达。ICMP还用于其他一些网络工具和协议中，例如traceroute，以便跟踪数据包的路径。

关系：

- **ICMP消息通常被包装在IP数据包中进行传输。这意味着ICMP消息是IP协议的一部分**，因为它们使用IP数据包进行传输。ICMP消息的IP头部信息包含源IP地址、目标IP地址和其他必要的信息。
- ICMP消息可以用于报告各种网络问题，例如目标不可达、超时、路由器错误等。这些消息可以帮助网络管理员诊断和解决网络问题。

总之，IP协议负责将数据包从一个地方传输到另一个地方，而ICMP协议则允许网络设备和主机在传输过程中交换控制和错误消息，以确保网络的可用性和健壮性。ICMP消息是在IP数据包中传输的，因此它们是紧密相关的协议。

### 1.2首部

#### 1.2.1版本、首部长度、区分服务

区分服务，例如，路由器发现有特殊的区分服务，会优先处理

![ ](imgs\image-20230919113536286.png)

过大的数据包，需要分成片传递给数据链路层，分成多个独立的以太网帧

#### 1.2.2总长度

![image-20230919115153090](imgs\image-20230919115153090.png)

#### 1.2.3标识、标志

过大的数据包，分成多个片，数据链路层整合时如何区分呢？

标识占2个字节，0~65535，超过65535，又会从0开始

==标识一样，属于同一数据包，片偏移确定顺序，根据总长度，算出下一片偏移的位置，根据标志中的第3位判断是否为最后一片，选择继续拼接还是结束== 

![image-20230919120753298](imgs\image-20230919120753298.png)

#### 1.2.4片偏移

网络层数据部分最大为1480

每一片都有首部，首部里的标识相同

作用：判断片是属于数据包的哪部分

字节偏移，13位可能存不下，存的片偏移要字节偏移除以8

片偏移不代表是第几个字节，乘以8得到字节偏移才是整个数据包的第多少个字节

![image-20230919124232139](imgs\image-20230919124232139.png)

![image-20230919155244678](imgs\image-20230919155244678.png)

#### 1.2.5协议、首部校验和

 ![image-20230919155808197](imgs\image-20230919155808197.png)

#### 1.2.6生存时间 

防止路由器的路由表配置错位，一直占用带宽（踢皮球）（防止路由死循环）



![image-20230919190452960](imgs\image-20230919190452960.png)

设置TTL，回复ip不同，用ping去递增TTL，可以知道数据包的路线，经过哪些路由器

或者用tracert、pathping命令

![image-20230920154644210](imgs\image-20230920154644210.png)

## 2.ping的用法 

![image-20230919140606371](imgs\image-20230919140606371.png)

ping baidu.com -l 800

数据链路层total length ：842

数据800+网络层首部20+ICMP协议首部8+数据链路层首部14（抓不到FCS）

![image-20230919141206249](imgs\image-20230919141206249.png)

ping ip -l 4000

1514=数据链路层首部14+网络层首部20+数据1480

1082=数据链路层首部14+网络层首部20+ICMP协议首部8+数据1040

0~1479 1480~2959 2960~3999

![image-20230919145919115](imgs\image-20230919145919115.png)



## 3.传输层

TCP:三次握手，建立通道，可靠传输，发现丢包情况，会重新发，首部占用空间大，传输慢，资源消耗大，资源传输完，需断开连接，否则服务器会一直通过一个端口去监听客户端发的数据，不断占用服务器的资源，应用场景：浏览器（HTTP、HTTPS），文件传输（FTP），邮件发送（SMTP）

UDP:无连接，直接把数据扔过去，不可靠传输，可能丢包，首部占用空间小，传输快，资源消耗小，应用场景：实时场景（DNS）(如果用TCP，信息会保证发过去，但顺序可能不对)

 ![image-20230920155439024](imgs\image-20230920155439024.png)

## 4.UDP



![image-20230921170431710](imgs\image-20230921170431710.png)

增加伪首部，是为了更多严谨，更加安全，检测能力更强

伪首部的数据是在计算检验和时，从网络层拿到

检验和分两类，一类是只算首部，另一类是算首部和数据

![image-20230921171545887](imgs\image-20230921171545887.png)

## 5.端口

端口是计算机网络中的重要概念，它用于标识和区分网络中不同应用程序或服务之间的通信通道。端口是一个数字，通常范围从0到65535。它们被分成三个范围：

1. **系统端口（Well-Known Ports）**：范围从0到1023。这些端口通常由操作系统和常见网络服务占用，例如HTTP（端口80）、HTTPS（端口443）、FTP（端口21）、SSH（端口22）、SMTP（端口25）等。这些端口的分配是由互联网分配号码管理局（IANA）管理的。
2. **注册端口（Registered Ports）**：范围从1024到49151。这些端口可以由应用程序或服务开发者注册，以用于自定义或专有的应用程序。虽然它们没有被固定分配给特定的协议或服务，但通常用于各种网络应用。
3. **动态或私有端口（Dynamic or Private Ports）**：范围从49152到65535。这些端口通常由客户端应用程序随机选择，用于建立与服务器应用程序的临时通信通道。它们不受特定的服务或应用程序约束。

端口的作用是在计算机网络中将数据包路由到正确的目的地。当一台计算机上运行多个网络服务或应用程序时，每个服务都可以监听不同的端口，以便将传入的数据包路由到正确的服务。通常，一个数据包的目的地由目标IP地址和目标端口号来确定。

例如，当您在Web浏览器中输入一个URL时，浏览器会使用HTTP协议默认的端口号80，或者如果您输入的是安全的URL（以"https://"开头），则使用默认的HTTPS端口号443。这样，服务器就知道将您的请求路由到相应的Web服务器上的HTTP或HTTPS服务。端口是网络通信中非常重要的一部分，它允许多个应用程序在同一台计算机上并行运行，并确保数据包按照正确的方式传输到目标应用程序。



**服务器的端口会一直开着，客户端的端口由操作系统动态分配**

![image-20230921175722022](imgs\image-20230921175722022.png)

 一般来说，服务器上的数据库不允许客户端直接访问

一般是通过http请求，到服务器上的tomcat软件，tomcat再去访问数据库(自己访问自己的服务 )

为了安全起见，服务器搞个防火墙，防火墙里明确要求TCP的3306端口不可进，只能通过内部访问

![image-20230921175536080](imgs\image-20230921175536080.png)